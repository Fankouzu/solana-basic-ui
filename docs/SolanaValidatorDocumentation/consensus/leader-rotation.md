# 领导者轮换

在任何给定时刻，一个集群只期望一个验证者产生账本条目。通过一次只指定一个领导者，所有验证者都可以重放相同的账本副本。然而，这种方式的缺陷是，恶意领导者可能会屏蔽投票和交易。由于屏蔽行为与网络丢包无法区分，集群不能简单地选举一个节点无限期地担任领导者角色。相反，集群通过轮换领导者节点来最小化恶意领导者的影响。

每个验证者使用相同的算法来选择预期的领导者，如下所述。当验证者收到新的签名过的账本条目时，可以确定该条目是由预期领导者产生的。每个领导者被分配到的槽位顺序称为 _领导者时间表_。

## 领导者时间表轮换

验证者会拒绝那些未由 _槽位领导者_ 签名的区块。所有槽位领导者的身份列表称为 _领导者时间表_。领导者时间表会在本地定期重新计算，分配的槽位领导者将持续一个称为 _纪元_ 的时间段。该时间表必须在其分配的槽位之前很早就计算出来，以确保计算时间表所使用的账本状态已经最终确定。这个时段称为 _领导者时间表偏移_。Solana 将偏移设置为到下一个纪元的槽位数量，即从上一个纪元的账本状态开始计算新纪元的领导者时间表。偏移一个纪元的长度相对任意，假设时间足够长，以便所有验证者在生成下一时间表之前完成账本状态的最终确定。集群可以选择缩短偏移时间，以减少权益变化和领导者时间表更新之间的时间。

在没有持续超过一个纪元的分区情况下，只有在根分支跨越纪元边界时才需要生成时间表。因为时间表适用于下一个纪元，任何提交到根分支的新权益将在下一个纪元才生效。用于生成领导者时间表的区块是第一个跨越纪元边界的区块。

在没有超过一个纪元的分区情况下，集群将按如下方式工作：

1. 验证者在投票时会持续更新其根分支。
2. 每当槽位高度跨越纪元边界时，验证者更新其领导者时间表。

例如：

假设一个纪元持续100个槽位，实际情况可能会更长。根分支从槽位高度为99的分支更新到高度为102的分支。由于故障，跳过了高度为100和101的槽位。使用高度为102的分支生成新的领导者时间表，该时间表在槽位200开始生效，直到下次更新。

不存在不一致情况，因为参与投票的所有验证者在其根分支通过102时都跳过了100和101槽位。所有验证者，无论投票模式如何，都将提交到高度为102或102的后代的根。

### 在纪元大小的分区下的领导者时间表轮换

领导者时间表偏移的持续时间与集群对正确的领导者时间表的视图一致性直接相关。

考虑以下情况：

两个分区分别生成一半的区块。由于没有达到超级多数分支的决策权，它们将分别通过纪元100和200，而没有实际提交到根分支，也因此没有集群范围的新的领导者时间表。

在这种不稳定情况下，会存在多个有效的领导者时间表。

- 为每个直接父级在上一个纪元中的分支生成一个领导者时间表。
- 该领导者时间表在下一个纪元开始后的后代分支上有效，直到它被更新。

当分区持续时间超过一个纪元时，各自的时间表会发生分歧。因此，纪元的持续时间应比槽位时间和预计的分支提交到根的时间长得多。

在观察集群足够长的时间后，可以根据分区的中位数持续时间及其标准差来选择领导者时间表偏移。例如，选择比分区中位数持续时间长六倍标准差的偏移，将集群中账本时间表不一致的概率降低到百万分之一。

## 创世时的领导者时间表生成

创世配置声明了第一个纪元的第一个领导者。由于领导者时间表在槽位0为下一个纪元生成，因此该领导者将在前两个纪元中被安排。创世配置中也可以指定前两个纪元的长度。第一个纪元的最小长度必须大于等于[塔式 BFT](../implemented-proposals/tower-bft.md)中定义的最大回滚深度。

## 领导者时间表生成算法

领导者时间表使用预定义种子生成，流程如下：

1. 定期使用 PoH 计时高度（单调递增计数器）作为稳定伪随机算法的种子。
2. 在该高度时，从银行中采样所有拥有领导者身份并在集群配置的多个计时中投票的质押账户。这个采样称为 _活跃集_。
3. 根据质押权重对活跃集排序。
4. 使用随机种子按质押权重选择节点，生成质押权重排序。
5. 该排序在集群配置的计时数后生效。

## 时间表攻击向量

### 种子

选定的种子是可预测的，但不可操控的。不存在消耗性攻击以影响其结果。

### 活跃集

领导者可以通过审查验证者投票来影响活跃集。领导者有两种可能的方式来审查活跃集：

- 忽略验证者的投票
- 拒绝为包含验证者投票的区块进行投票

为了降低审查的可能性，活跃集是在领导者时间表偏移边界处的 _活跃集采样持续时间_ 内计算的。活跃集采样持续时间足够长，以便多个领导者已经收集了投票。

### 质押

领导者可以审查新的质押交易，或拒绝验证包含新质押的区块。这种攻击类似于对验证者投票的审查。

### 验证者操作密钥丢失

领导者和验证者应使用临时密钥进行操作，质押所有者通过委托授权验证者使用其质押进行工作。

集群应该能够从领导者和验证者使用的所有临时密钥丢失中恢复，这种情况可能由于所有节点共享的常见软件漏洞而发生。即使质押目前已委托给验证者，质押所有者也应该能够通过共同签署验证者投票直接投票。

## 追加条目

领导者时间表的生命周期称为 _纪元_。纪元被分成 _槽位_，每个槽位的持续时间为 `T` PoH 计时。

领导者在其槽位期间传输条目。`T` 计时后，所有验证者切换到下一个计划的领导者。验证者必须忽略领导者分配槽位外发送的条目。

下一个领导者必须观察到所有 `T` 计时，才能构建其条目。如果未观察到条目（领导者宕机）或条目无效（领导者故障或恶意），下一个领导者必须生成计时以填充先前领导者的槽位。注意，下一个领导者应并行执行修复请求，并推迟发送计时，直到确认其他验证者也未观察到先前领导者的条目。如果领导者错误地在其自身计时上构建，则后续领导者必须替换其所有计时。
